@{
    ViewData["Title"] = "Galaxy Defender";
}

<div class="game-wrapper">
    <div class="game-ui">
        <div class="stats-row">
            <div class="stat-box">
                <span class="label">SCORE</span>
                <span id="score" class="value">000000</span>
            </div>
            <div class="stat-box">
                <span class="label">VIDAS</span>
                <div id="livesContainer" class="lives-icons">
                    <span class="heart">❤</span>
                    <span class="heart">❤</span>
                    <span class="heart">❤</span>
                </div>
            </div>
        </div>
        <div class="controls-hint">[SETAS] Mover • [ESPAÇO] Atirar</div>
    </div>

    <canvas id="galaxyCanvas"></canvas>

    <div id="gameOverScreen" class="overlay hidden">
        <div class="overlay-content">
            <h1 id="gameOverTitle" class="glitch-text">MISSION FAILED</h1>
            <p id="gameOverReason" style="color: #ccc; margin-bottom: 10px;"></p>
            <p>Sua pontuação final: <span id="finalScore">0</span></p>
            <button onclick="location.reload()" class="btn-restart">REINICIAR SISTEMAS</button>
        </div>
    </div>
</div>

<style>
    .game-wrapper {
        position: relative;
        width: 100vw;
        height: calc(100vh - 56px);
        background: radial-gradient(circle, #101020 0%, #000 100%);
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #galaxyCanvas {
        border: 2px solid rgba(157, 78, 221, 0.3);
        background-color: black;
    }

    .game-ui {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 5;
        font-family: 'Segoe UI', sans-serif;
    }

    .stats-row {
        display: flex;
        gap: 40px;
    }

    .stat-box .label {
        color: #9d4edd;
        font-size: 0.8rem;
        display: block;
    }

    .stat-box .value {
        color: #fff;
        font-size: 1.8rem;
        font-weight: bold;
    }

    .lives-icons {
        font-size: 1.5rem;
        color: #ff0055;
        text-shadow: 0 0 10px #ff0055;
    }

    .heart {
        margin-right: 5px;
        transition: 0.3s;
    }

        .heart.lost {
            color: #444;
            text-shadow: none;
            opacity: 0.3;
        }

    .overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        backdrop-filter: blur(8px);
    }

        .overlay.hidden {
            display: none;
        }

    .overlay-content {
        text-align: center;
        border: 2px solid #ff0055;
        padding: 50px;
        border-radius: 20px;
        background: #100005;
    }

    .glitch-text {
        color: #ff0055;
        text-shadow: 0 0 15px #ff0055;
        font-size: 3rem;
    }

    .btn-restart {
        background: transparent;
        border: 1px solid #9d4edd;
        color: #fff;
        padding: 12px 30px;
        cursor: pointer;
        margin-top: 20px;
    }

        .btn-restart:hover {
            background: #9d4edd;
            box-shadow: 0 0 20px #9d4edd;
        }
</style>

@section Scripts {
    <script>
        const canvas = document.getElementById('galaxyCanvas');
        const ctx = canvas.getContext('2d');
        const scoreVal = document.getElementById('score');
        const livesIcons = document.querySelectorAll('.heart');

        // Configuração do Canvas
        canvas.width = 900;
        canvas.height = 550;

        // Carregar Imagem do Asteroide
        const asteroidImg = new Image();
        asteroidImg.src = '/img/asteroide.jpg';

        let score = 0;
        let lives = 3;
        let gameActive = true;

        const ship = {
            x: 50, y: canvas.height / 2, w: 45, h: 25, speed: 6,
            draw() {
                ctx.fillStyle = '#00d4ff';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00d4ff';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x + this.w, this.y + this.h/2);
                ctx.lineTo(this.x, this.y + this.h);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        };

        const projectiles = [];
        const invaders = [];
        const keys = {};

        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function showGameOver(reason) {
            gameActive = false;
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverReason').innerText = reason;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function spawnInvader() {
            if(!gameActive) return;
            invaders.push({
                x: canvas.width,
                y: Math.random() * (canvas.height - 50),
                w: 45, h: 45, // Tamanho ajustado para a imagem
                speed: 3 + (score / 2000),
                angle: 0,
                rotationSpeed: (Math.random() - 0.5) * 0.1
            });
            setTimeout(spawnInvader, Math.max(400, 1200 - (score / 15)));
        }

        function update() {
            if(!gameActive) return;

            // Movimento da Nave
            if(keys['ArrowUp'] && ship.y > 0) ship.y -= ship.speed;
            if(keys['ArrowDown'] && ship.y < canvas.height - ship.h) ship.y += ship.speed;

            // Tiro
            if(keys['Space']) {
                if(projectiles.length < 6) {
                    projectiles.push({ x: ship.x + ship.w, y: ship.y + ship.h/2 });
                    keys['Space'] = false;
                }
            }

            // Atualizar Tiros
            projectiles.forEach((p, i) => {
                p.x += 10;
                if(p.x > canvas.width) projectiles.splice(i, 1);
            });

            // Atualizar Inimigos
            invaders.forEach((inv, i) => {
                inv.x -= inv.speed;
                inv.angle += inv.rotationSpeed; // Faz o asteroide girar

                // 1. Colisão com a Nave
                if(ship.x < inv.x + inv.w * 0.7 && ship.x + ship.w > inv.x + inv.w * 0.2 &&
                   ship.y < inv.y + inv.h * 0.7 && ship.y + ship.h > inv.y + inv.h * 0.2) {
                    showGameOver("Impacto direto! Sua nave foi destruída.");
                }

                // 2. Passou da tela
                if(inv.x + inv.w < 0) {
                    invaders.splice(i, 1);
                    lives--;
                    if(lives >= 0) livesIcons[lives].classList.add('lost');
                    if(lives <= 0) showGameOver("Os asteroides atingiram a base planetária!");
                    return;
                }

                // 3. Colisão com Tiros
                projectiles.forEach((p, pi) => {
                    if(p.x > inv.x && p.x < inv.x + inv.w && p.y > inv.y && p.y < inv.y + inv.h) {
                        invaders.splice(i, 1);
                        projectiles.splice(pi, 1);
                        score += 100;
                        scoreVal.innerText = score.toString().padStart(6, '0');
                    }
                });
            });
        }

        function loop() {
            // Limpa tudo para não deixar rastro
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ship.draw();

            // Desenhar Tiros
            ctx.fillStyle = '#fffc33';
            projectiles.forEach(p => ctx.fillRect(p.x, p.y - 2, 10, 4));

            // Desenhar Asteroides com Rotação
            invaders.forEach(inv => {
                ctx.save();
                ctx.translate(inv.x + inv.w / 2, inv.y + inv.h / 2);
                ctx.rotate(inv.angle);

                if (asteroidImg.complete) {
                    ctx.drawImage(asteroidImg, -inv.w / 2, -inv.h / 2, inv.w, inv.h);
                } else {
                    // Backup caso a imagem falhe
                    ctx.fillStyle = '#ff0055';
                    ctx.fillRect(-inv.w / 2, -inv.h / 2, inv.w, inv.h);
                }
                ctx.restore();
            });

            update();
            if(gameActive) requestAnimationFrame(loop);
        }

        spawnInvader();
        loop();
    </script>
}