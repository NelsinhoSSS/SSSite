@{
    ViewData["Title"] = "Shuffle Cups";
}

<div class="shuffle-main-container">
    <div class="game-board">
        <div class="score-badge">SCORE: <span id="scoreVal">0</span></div>

        <div class="board-header">
            <h1>SHUFFLE CUPS</h1>
            <p id="status">Clique em INICIAR para começar</p>
            <button id="btnStart" class="btn-neon" onclick="startGame()">INICIAR JOGO</button>
        </div>

        <div class="cups-area" id="cupsArea">
            <div class="cup-slot" id="slot-0">
                <div class="cup" onclick="selectCup(this)">
                    <div class="cup-rim"></div>
                </div>
                <div class="ball" id="goldBall"></div>
            </div>

            <div class="cup-slot" id="slot-1">
                <div class="cup" onclick="selectCup(this)">
                    <div class="cup-rim"></div>
                </div>
            </div>

            <div class="cup-slot" id="slot-2">
                <div class="cup" onclick="selectCup(this)">
                    <div class="cup-rim"></div>
                </div>
            </div>
        </div>

        <div class="board-floor"></div>
    </div>
</div>

<style>
    .shuffle-main-container {
        height: calc(100vh - 56px);
        background: #0a0a0c;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .game-board {
        width: 850px;
        height: 500px;
        background: #15151e;
        border: 2px solid #3d2b56;
        border-radius: 20px;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
        overflow: hidden;
    }

    /* ESTILO DA PONTUAÇÃO */
    .score-badge {
        position: absolute;
        top: 20px;
        right: 30px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 1.5rem;
        color: #fffc33;
        text-shadow: 0 0 10px rgba(255, 252, 51, 0.5);
        font-weight: bold;
        z-index: 20;
    }

    .board-header {
        margin-top: 30px;
        text-align: center;
        z-index: 10;
    }

        .board-header h1 {
            color: #bc6ff1;
            letter-spacing: 5px;
            margin-bottom: 5px;
        }

        .board-header p {
            color: #888;
            font-weight: bold;
            font-size: 1.2rem;
            min-height: 1.5em;
        }

    .cups-area {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        width: 100%;
        height: 250px;
        margin-top: 50px;
        padding: 0 50px;
        position: relative;
    }

    .cup-slot {
        width: 120px;
        height: 160px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        transition: transform 0.5s ease-in-out; /* O JS vai controlar essa velocidade */
    }

    .cup {
        width: 110px;
        height: 140px;
        background: linear-gradient(135deg, #7b2cbf 0%, #3c096c 100%);
        clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%);
        border-top: 4px solid #9d4edd;
        cursor: pointer;
        z-index: 5;
        position: relative;
        transition: transform 0.3s ease;
    }

    .cup-rim {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 5px;
        background: rgba(255,255,255,0.1);
    }

    .cup.raised {
        transform: translateY(-100px);
    }

    .ball {
        width: 35px;
        height: 35px;
        background: radial-gradient(circle at 30% 30%, #fffc33, #b8860b);
        border-radius: 50%;
        position: absolute;
        bottom: 5px;
        z-index: 2;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        display: none;
    }

    .board-floor {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 80px;
        background: linear-gradient(to top, #1a1a2e, transparent);
        border-top: 1px solid rgba(157, 78, 221, 0.2);
    }

    .btn-neon {
        background: transparent;
        border: 1px solid #bc6ff1;
        color: #bc6ff1;
        padding: 8px 25px;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
        font-weight: bold;
    }

        .btn-neon:hover {
            background: #bc6ff1;
            color: white;
            box-shadow: 0 0 15px #bc6ff1;
        }
</style>

@section Scripts {
    <script>
        let isMoving = false;
        let canPick = false;
        let score = 0;
        let baseSpeed = 500; // Começo lento (500ms por troca)
        let currentSpeed = baseSpeed;

        function startGame() {
            if (isMoving) return;

            document.querySelectorAll('.cup').forEach(c => c.classList.remove('raised'));
            const ball = document.getElementById('goldBall');
            ball.style.display = "block";

            const cupWithBall = ball.parentElement.querySelector('.cup');
            cupWithBall.classList.add('raised');

            document.getElementById('status').innerText = "Observe a bola!";
            document.getElementById('status').style.color = "#888";

            setTimeout(() => {
                cupWithBall.classList.remove('raised');
                setTimeout(() => {
                    shuffle();
                }, 500);
            }, 1200);
        }

        async function shuffle() {
            isMoving = true;
            canPick = false;
            document.getElementById('status').innerText = "Embaralhando...";
            document.getElementById('status').style.color = "#bc6ff1";

            const startTime = Date.now();
            const duration = 5000; // Exatos 5 segundos

            while (Date.now() - startTime < duration) {
                const slots = document.querySelectorAll('.cup-slot');
                let a = Math.floor(Math.random() * 3);
                let b = Math.floor(Math.random() * 3);
                while (a === b) b = Math.floor(Math.random() * 3);

                await swap(slots[a], slots[b]);
            }

            isMoving = false;
            canPick = true;
            document.getElementById('status').innerText = "Onde ela está?";
            document.getElementById('status').style.color = "#00d4ff";
        }

        function swap(el1, el2) {
            return new Promise(resolve => {
                const rect1 = el1.getBoundingClientRect();
                const rect2 = el2.getBoundingClientRect();
                const diffX = rect2.left - rect1.left;

                // Aplica a velocidade atual na transição CSS
                el1.style.transition = `transform ${currentSpeed}ms ease-in-out`;
                el2.style.transition = `transform ${currentSpeed}ms ease-in-out`;

                el1.style.transform = `translateX(${diffX}px)`;
                el2.style.transform = `translateX(${-diffX}px)`;

                setTimeout(() => {
                    el1.style.transition = "none";
                    el2.style.transition = "none";
                    el1.style.transform = "";
                    el2.style.transform = "";

                    const parent = el1.parentNode;
                    const sibling1 = el1.nextSibling;
                    const sibling2 = el2.nextSibling;

                    if (sibling1 === el2) {
                        parent.insertBefore(el2, el1);
                    } else if (sibling2 === el1) {
                        parent.insertBefore(el1, el2);
                    } else {
                        parent.insertBefore(el2, sibling1);
                        parent.insertBefore(el1, sibling2);
                    }

                    void el1.offsetWidth;
                    resolve();
                }, currentSpeed); // Tempo de espera igual à velocidade da animação
            });
        }

        function selectCup(cupElement) {
            if (!canPick) return;

            cupElement.classList.add('raised');
            const slot = cupElement.parentElement;

            if (slot.querySelector('.ball')) {
                score++;
                document.getElementById('scoreVal').innerText = score;
                document.getElementById('status').innerText = "BRILHANTE! Ficando mais rápido...";
                document.getElementById('status').style.color = "#fffc33";

                // Aumenta a velocidade em 1.5x (reduz o tempo necessário)
                // Limite mínimo de 100ms para não ficar impossível ou bugar o CSS
                currentSpeed = Math.max(100, currentSpeed / 1.5);

            } else {
                document.getElementById('status').innerText = "ERROU! Pontuação reiniciada.";
                document.getElementById('status').style.color = "#ff0055";

                // Reinicia a pontuação e a velocidade ao errar
                score = 0;
                currentSpeed = baseSpeed;
                document.getElementById('scoreVal').innerText = score;

                setTimeout(() => {
                    document.querySelector('.ball').parentElement.querySelector('.cup').classList.add('raised');
                }, 800);
            }

            canPick = false;
        }
    </script>
}